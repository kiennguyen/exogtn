<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Simple OAuth Gadget" scrolling="true">
    <Require feature="locked-domain"/>
    <Require feature="oauthpopup" />
    <OAuth>
      <Service name="SimpleOAuth">
        <Access url="http://localhost:8080/exo-oauth-provider/access_token" method="GET" />
        <Request url="http://localhost:8080/exo-oauth-provider/request_token" method="GET" />
        <Authorization url="http://localhost:8080/exo-oauth-provider/authorize?oauth_callback=http://localhost:8080/eXoGadgetServer/gadgets/oauthcallback" method="GET" />
      </Service>
    </OAuth>
  </ModulePrefs>
  <Content type="html">
  <![CDATA[

  <style>
  #main {
    margin: 0px;
    padding: 0px;
    font-size: small;
  }
  </style>

  <div id="main" style="display: none">
  </div>

  <div id="approval" style="display: none">
    <img src="new.gif">
    <a href="#" id="personalize">Personalize this gadget</a>
  </div>

  <div id="waiting" style="display: none">
    Please click
    <a href="#" id="approvaldone">I've approved access</a>
    once you've approved access to your data.
  </div>

  <script type="text/javascript">
    function showOneSection(toshow) {
      var sections = [ 'main', 'approval', 'waiting' ];
      for (var i=0; i < sections.length; ++i) {
        var s = sections[i];
        var el = document.getElementById(s);
        if (s === toshow) {
          el.style.display = "block";
        } else {
          el.style.display = "none";
        }
      }
    }

    // Process returned JSON feed to display data.
    function showResults(result) {
      showOneSection('main');

      var titleElement = document.createElement('div');
      var nameNode = document.createTextNode(result);
      titleElement.appendChild(nameNode);
      document.getElementById("main").appendChild(titleElement);
    }

    function fetchData() {
      var params = {};
      url = "http://localhost:8080/exo-oauth-provider/rest/simple";
      params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.TEXT;
      params[gadgets.io.RequestParameters.AUTHORIZATION] = gadgets.io.AuthorizationType.OAUTH;
      params[gadgets.io.RequestParameters.OAUTH_SERVICE_NAME] = "SimpleOAuth";
      params[gadgets.io.RequestParameters.OAUTH_USE_TOKEN] = "always";
      params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;

      gadgets.io.makeRequest(url, function (response) {
        if (response.oauthApprovalUrl) {
          var onOpen = function() {
      	  	showOneSection('waiting');
      	  }
      	  	
      	  var onClose = function() {
      	  	fetchData();
      	  }
          var popup = new gadgets.oauth.Popup(response.oauthApprovalUrl,
                                                "height=300,width=200",
                                                onOpen,
                                                onClose
                                              );
                                              
          var personalize = document.getElementById('personalize');
          personalize.onclick = popup.createOpenerOnClick();
          var approvaldone = document.getElementById('approvaldone');
          approvaldone.onclick = popup.createApprovedOnClick();
          showOneSection('approval');
        } else if (response.data) {
            showOneSection('main');
            showResults(response.data);
        } else {
            var main = document.getElementById('main');
            var err = document.createTextNode('OAuth error: ' +
              response.oauthError + ': ' + response.oauthErrorText);
            main.appendChild(err);
            showOneSection('main');
        }
      }, params);
    }
    // Call fetchData() when gadget loads.
    gadgets.util.registerOnLoadHandler(fetchData);
  </script>
  ]]>
  </Content>
</Module>
